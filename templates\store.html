<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t('page_store') }} - ŸÖÿ™ÿ¨ÿ± ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arabic Typography', Arial, sans-serif; background: #f5f5f5; color: #333; }
        .language-switcher { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 1000; }
        .lang-btn { padding: 8px 15px; background: white; border: 2px solid #667eea; border-radius: 5px; cursor: pointer; font-weight: 600; color: #667eea; transition: all 0.3s; text-decoration: none; display: inline-block; font-size: 12px; }
        .lang-btn.active { background: #667eea; color: white; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:20px; }
        .logo { font-size:24px; font-weight:bold; }
        .search-bar { flex:1; min-width:250px; display:flex; gap:10px; }
        .search-bar input { flex:1; padding:10px; border:none; border-radius:5px; }
        .search-bar button { padding:10px 20px; background:#333; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:600; }
        .nav { display:flex; gap:20px; align-items:center; }
        .products-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:20px; margin-bottom:30px; }
        .product-card { background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); transition:transform .3s; cursor:pointer; }
        .product-image { width:100%; height:200px; background:#f0f0f0; display:flex; align-items:center; justify-content:center; font-size:60px; color:#ddd; }
        .product-info { padding:15px; }
        .product-name { font-weight:600; font-size:16px; margin-bottom:8px; color:#333; }
        .product-description { font-size:13px; color:#666; margin-bottom:10px; line-height:1.4; display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:2; line-clamp:2; overflow:hidden; }
        .product-footer { display:flex; justify-content:space-between; align-items:center; margin-top:12px; }
        .product-price { font-size:18px; font-weight:bold; color:#667eea; }
        .add-to-cart-btn { padding:8px 12px; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:600; }
        @media (max-width:768px) { .products-grid { grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); } }
    </style>
</head>
<body>
    <div class="language-switcher">
        <a href="/set-language/ar" class="lang-btn {% if lang == 'ar' %}active{% endif %}">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</a>
        <a href="/set-language/en" class="lang-btn {% if lang == 'en' %}active{% endif %}">English</a>
    </div>

    <header>
        <div class="header-content">
            <div class="logo">üõçÔ∏è {{ t('nav_store') }}</div>
            <div class="search-bar">
                <form style="display:flex; width:100%; gap:10px;">
                    <input type="text" name="search" placeholder="{{ t('search_placeholder') }}" value="{{ request.args.get('search', '') }}">
                    <button type="submit">{{ t('nav_store') }}</button>
                </form>
            </div>
            <div class="nav">
                <a href="/store">{{ t('nav_store') }}</a>
                <a href="/orders">{{ t('nav_orders') }}</a>
                <a href="/profile">{{ t('nav_profile') }}</a>
                <a href="/cart">üõí {% if cart_count > 0 %}<span class="cart-count">{{ cart_count }}</span>{% endif %}</a>
                <a href="/logout">{{ t('nav_logout') }}</a>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="filter-section" style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;">
            <label for="category">{{ t('filter_category') }}:</label>
            <select id="category" onchange="filterByCategory(this.value)">
                <option value="all" {% if request.args.get('category', 'all') == 'all' %}selected{% endif %}>{{ t('all_categories') }}</option>
                {% for cat in categories %}
                    <option value="{{ cat }}" {% if request.args.get('category') == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>
        </div>

        {% if products %}
            <div class="products-grid">
                {% for product in products %}
                    <div class="product-card" onclick="location.href='/product/{{ product[0] }}'">
                        <div class="product-image">üì¶</div>
                        <div class="product-info">
                            <div class="product-name">{{ product[1] }}</div>
                            <div class="product-description">{{ product[2] }}</div>
                            <div class="product-footer">
                                <span class="product-price">{{ product[3] }} ÿ±.ÿ≥</span>
                                <button class="add-to-cart-btn" onclick="event.stopPropagation(); addToCart('{{ product[0] }}')">{{ t('add_to_cart') }}</button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-message"><p>{{ t('no_products') }}</p></div>
        {% endif %}
    </div>

    <script>
        function filterByCategory(category) {
            const url = new URL(window.location);
            if (category === 'all') url.searchParams.delete('category'); else url.searchParams.set('category', category);
            window.location = url.toString();
        }

        // Main addToCart handler (parses id and posts)
        function addToCart(productId) {
            productId = parseInt(productId);
            const form = new FormData();
            form.append('quantity', 1);
            fetch(`/add-to-cart/${productId}`, { method: 'POST', body: form })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("{{ t(\"success_add_cart\") }}");
                        location.reload();
                    } else {
                        alert(data.error || 'Error');
                    }
                })
                .catch(err => { console.error(err); alert('Error'); });
        }

        // removeFromCart: used on cart page
        function removeFromCart(itemId) {
            itemId = parseInt(itemId);
            if (!confirm("{{ t(\"confirm_delete\") }}")) return;
            const form = new FormData();
            fetch(`/remove-from-cart/${itemId}`, { method: 'POST', body: form })
                .then(res => res.json()).then(data => location.reload()).catch(err => { console.error(err); alert('Error'); });
        }
    </script>
</body>
</html>
